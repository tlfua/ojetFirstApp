{"version":3,"file":"UNSAFE_DrawerPopup.js","sources":["../../src/UNSAFE_DrawerPopup/DrawerPopup.tsx"],"sourcesContent":["import { JSX, RefObject } from 'preact';\nimport { useState, useRef, useEffect, useCallback } from 'preact/hooks';\nimport { Layer } from '../UNSAFE_Layer';\nimport { Modal } from '../UNSAFE_Modal';\nimport { FocusTrap } from '../UNSAFE_FocusTrap';\nimport { focusOn, focusWithin, getActiveElement } from '../utils/PRIVATE_tabbableUtils';\nimport { normalizePosition } from '../utils/PRIVATE_floatingUtils';\nimport { RtlSide } from '../UNSAFE_Floating';\nimport { getClientHints } from '../utils/PRIVATE_clientHints';\n\n// Hooks\nimport { useOutsideClick } from '../hooks/UNSAFE_useOutsideClick';\nimport { useAnimation } from '../hooks/UNSAFE_useAnimation';\nimport { useUser } from '../hooks/UNSAFE_useUser';\n\n// Style imports\nimport { useComponentTheme } from '../hooks/UNSAFE_useComponentTheme';\nimport { DrawerPopupVariantOptions } from './themes/DrawerPopupStyles.css';\nimport { colorInterpolations, ColorProps } from '../utils/UNSAFE_interpolations/colors';\nimport { mergeInterpolations } from '../utils/UNSAFE_mergeInterpolations';\nimport { DrawerPopupRedwoodTheme } from './themes/redwood/DrawerPopupTheme';\n\n// Types\ntype IntrinsicProps = Pick<JSX.HTMLAttributes<HTMLDivElement>, 'children'>;\ntype Placement = 'start' | 'end' | 'bottom';\ntype NormalizedPlacement = 'left' | 'right' | 'bottom';\ntype Status = 'unmounted' | 'initial' | 'opening' | 'closing';\ntype VisibilityStatus = 'hidden' | 'visible';\ntype DisplayModeHorizontal = 'overlay' | 'fullOverlay';\ntype OnCloseDetail = {\n  reason: 'outsideClick' | 'escapeKey';\n};\n\ntype Props = IntrinsicProps &\n  Pick<ColorProps, 'backgroundColor'> & {\n    /**\n     * Specifies whether the Drawer is open.\n     */\n    isOpen: boolean;\n    /**\n     * Specifies at what edge the Drawer opens.\n     * Supported values are:\n     * <p><code>start</code>, <code>end</code>, <code>bottom</code></p>\n     * Default is <code>start</code>.\n     */\n    placement?: Placement;\n    /**\n     * Specifies modality of the Darwer.\n     * Supported values are:\n     * <p><code>modal</code>, <code>modeless</code></p>\n     * Default is <code>modal</code>.\n     */\n    modality?: 'modal' | 'modeless';\n    /**\n     * Specifies callback triggered when a user tries to close a Drawer through UI interaction.\n     * The parent should listen to this event and close the Drawer. If the parent fails to remove\n     * the Popup, then no change will be done in the UI by the component.\n     * Supported detail values are:\n     * <p><code>outsideClick</code>, <code>escapeKey</code></p>\n     */\n    onClose?: (detail: OnCloseDetail) => void;\n    /**\n     * Specifies callback triggered after the animation ends.\n     */\n    onTransitionEnd?: (value: boolean) => void;\n    /**\n     * Optional ref for an element to focus on when component mounts.\n     */\n    autoFocusRef?: RefObject<HTMLElement>;\n    /**\n     * Specifies guidance for screen readers.\n     */\n    'aria-label'?: string;\n    /**\n     * Specifies ID of an element used for guidance for screen readers.\n     */\n    'aria-labelledby'?: string;\n    /**\n     * Specifies ID of an element (or space separated IDs of multiple elements) that\n     * describes the Drawer.\n     */\n    'aria-describedby'?: string;\n  };\n\n// Constants\nconst displayModefullWidthThreshold = 600;\nconst zero = '0px';\nconst duration = 250;\n\nconst getElementHeight = (element: HTMLDivElement): number => {\n  return Math.round(element.offsetHeight);\n};\n\nconst getElementWidth = (element: HTMLDivElement): number => {\n  return Math.round(element.getBoundingClientRect().width);\n};\n\n/**\n * A drawer popup adds a single slide-in side content alongside some primary content to an application window.\n *\n * This drawer always overlays the page and can be placed at the 'start', 'end' or 'bottom' edge.\n */\nexport const DrawerPopup = ({\n  children,\n  isOpen = false,\n  autoFocusRef,\n  placement = 'start',\n  modality = 'modal',\n  onClose,\n  onTransitionEnd,\n  'aria-label': ariaLabel,\n  'aria-labelledby': ariaLabelledBy,\n  'aria-describedby': ariaDescribedBy,\n  ...props\n}: Props) => {\n  // Initialize states\n  const [status, setStatus] = useState<Status>(isOpen ? 'initial' : 'unmounted');\n  const [visibility, setVisibility] = useState<VisibilityStatus>('hidden');\n  const [isOutsideClickDisabled, setIsOutsideClickDisabled] = useState<boolean>(!isOpen);\n  const [displayModeHorizontal, setDisplayModeHorizontal] =\n    useState<DisplayModeHorizontal>('overlay');\n\n  const rootRef = useRef<HTMLDivElement>(null);\n  const launcherRef = useRef<HTMLElement | null>(null);\n\n  const isBottomPlacement = placement === 'bottom';\n\n  // Animation config\n  const animationStates = {\n    opening: () => {\n      if (isBottomPlacement) {\n        return {\n          from: {\n            translateY: getTranslateY()\n          },\n          to: {\n            translateY: zero\n          },\n          options: {\n            duration: duration\n          }\n        };\n      } else {\n        return {\n          from: {\n            translateX: getTranslateX()\n          },\n          to: {\n            translateX: zero\n          },\n          options: {\n            duration: duration\n          }\n        };\n      }\n    },\n    closing: () => {\n      if (isBottomPlacement) {\n        return {\n          from: {\n            translateY: zero\n          },\n          to: {\n            translateY: getTranslateY()\n          },\n          options: {\n            duration: duration\n          }\n        };\n      } else {\n        return {\n          from: {\n            translateX: zero\n          },\n          to: {\n            translateX: getTranslateX()\n          },\n          options: {\n            duration: duration\n          }\n        };\n      }\n    }\n  };\n\n  // Normalizing position\n  const { direction } = useUser();\n  const getNormalizedPlacement = (): RtlSide => {\n    return normalizePosition(placement, direction);\n  };\n\n  const getTranslateX = (): string => {\n    return `${getNormalizedPlacement() === 'right' ? '' : '-'}${getElementWidth(\n      rootRef.current as HTMLDivElement\n    )}px`;\n  };\n\n  const getTranslateY = (): string => {\n    return `${getElementHeight(rootRef.current as HTMLDivElement)}px`;\n  };\n\n  // Animation\n  const { nodeRef } = useAnimation<Status, HTMLDivElement>(status, {\n    animationStates,\n    isAnimatedOnMount: true,\n    onAnimationEnd: useCallback(() => {\n      if (status === 'opening') {\n        onTransitionEnd?.(true);\n      } else if (!isOpen) {\n        nodeRef(null);\n        setVisibility('hidden');\n        setStatus('unmounted');\n        onTransitionEnd?.(false);\n      }\n    }, [status, isOpen])\n  });\n\n  useEffect(() => {\n    // 1. Ignore status update on initial render\n    if (status === 'unmounted' && !isOpen) {\n      return;\n    }\n\n    // 2. Mount visually hidden component\n    // Component gets mounted, but will be visually hidden to avoid flickering\n    // Flickering happens because it gets rendered before animation hook repositions\n    // it in next render cycle\n    if (status === 'unmounted' && isOpen) {\n      setStatus('initial');\n      return;\n    }\n\n    // 3. Setup animation\n    // Component has been mounted.\n    // We will kick out animation as node is already present in DOM.\n    // To avoid flickering, we still keep it visually hidden until the next render cycle.\n    if (status === 'initial' && isOpen) {\n      nodeRef(rootRef.current);\n      setIsOutsideClickDisabled(false);\n      setStatus('opening');\n      return;\n    }\n\n    // 3. Unhide component. It becomes visible.\n    if (status === 'opening' && isOpen) {\n      setVisibility('visible');\n      return;\n    }\n\n    // 4. Closing\n    if (!isOpen) {\n      setIsOutsideClickDisabled(true);\n      setStatus('closing');\n    }\n  }, [isOpen, status]);\n\n  // Launcher handler\n  useEffect(() => {\n    if (status === 'opening') {\n      // Remember launcher\n      const activeElement = getActiveElement();\n      launcherRef.current = activeElement === document.body ? document.body : activeElement;\n\n      // Register F6 key handler to enter the Popup\n      launcherRef.current?.addEventListener('keydown', launcherKeyDownCallback);\n    }\n    if (status === 'closing') {\n      return () => {\n        // Deregister F6 key handler\n        launcherRef.current?.removeEventListener('keydown', launcherKeyDownCallback);\n      };\n    }\n    return;\n  }, [status]);\n\n  const launcherKeyDownCallback = (event: KeyboardEvent): void => {\n    // Moves focus from launcher (must have focus) back to the Drawer\n    if (launcherRef.current === getActiveElement() && event.code === 'F6') {\n      // Prevent default F6 handlers.\n      // F6 is a standard Chrome address bar shortcut on Windows.\n      event.preventDefault();\n      event.stopPropagation();\n\n      // Focus on first tabbable in a container or container itself if there is none\n      focusWithin(rootRef.current as HTMLElement);\n    }\n  };\n\n  const handleKeyDown = useCallback(\n    (event: KeyboardEvent) => {\n      const launcherEl = launcherRef.current;\n      switch (event.code) {\n        case 'Escape': {\n          onClose?.({ reason: 'escapeKey' });\n          break;\n        }\n        case 'F6':\n          // Prevent default F6 handlers.\n          // F6 is a standard Chrome address bar shortcut on Windows.\n          event.preventDefault();\n          event.stopPropagation();\n          // Focus launcher\n          if (launcherEl) {\n            focusOn(launcherEl);\n          }\n          break;\n      }\n    },\n    [onClose]\n  );\n\n  // OutsideClick handler\n  const handleOutsideClick = useCallback(() => {\n    // Trigger onClose event with outside click detail\n    onClose?.({ reason: 'outsideClick' });\n  }, [onClose]);\n\n  useOutsideClick({\n    isDisabled: isOutsideClickDisabled,\n    ref: rootRef,\n    handler: handleOutsideClick\n  });\n\n  // Drawer placement\n  const getDrawerPlacement = (): NormalizedPlacement => {\n    if (isBottomPlacement) {\n      return placement;\n    } else {\n      if (direction === 'rtl') {\n        return placement === 'start' ? 'right' : 'left';\n      } else {\n        return placement === 'start' ? 'left' : 'right';\n      }\n    }\n  };\n\n  // Window resize handler\n  // Handles display mode: Overlay <> Full overlay (full width side drawers)\n  const handleResize = () => {\n    const viewportWidth = getViewportWidth();\n    if (displayModeHorizontal === 'overlay' && viewportWidth < displayModefullWidthThreshold) {\n      setDisplayModeHorizontal('fullOverlay');\n    }\n    if (displayModeHorizontal === 'fullOverlay' && viewportWidth > displayModefullWidthThreshold) {\n      setDisplayModeHorizontal('overlay');\n    }\n  };\n\n  const clientHints = getClientHints();\n  const getViewportWidth = (): number => {\n    if (clientHints.platform === 'ios') {\n      // On ios window.innerWidth is not recommended way of measuring the viewport\n      return document.documentElement.clientWidth;\n    }\n    return window.innerWidth;\n  };\n\n  useEffect(() => {\n    const root = rootRef.current;\n    if (root) {\n      const resizeObserver = new ResizeObserver(() => {\n        handleResize();\n      });\n      resizeObserver.observe(document.body);\n      return () => {\n        resizeObserver.unobserve(document.body);\n      };\n    }\n    return undefined;\n  }, [handleResize]);\n\n  // Styles\n  const { classes } = useComponentTheme<DrawerPopupVariantOptions>(DrawerPopupRedwoodTheme, {\n    placement: getDrawerPlacement(),\n    visibility,\n    displayModeHorizontal\n  });\n\n  const interpolations = [...Object.values(colorInterpolations)];\n  const styleInterpolations = mergeInterpolations<ColorProps>(interpolations);\n  const { ...styles } = styleInterpolations(props);\n\n  const renderDrawer = () => {\n    return (\n      <div\n        ref={rootRef}\n        className={classes}\n        style={styles}\n        tabIndex={-1}\n        role=\"dialog\"\n        onKeyDown={handleKeyDown}\n        aria-label={ariaLabel}\n        aria-labeledby={ariaLabelledBy}\n        aria-describedby={ariaDescribedBy}>\n        <FocusTrap autoFocusRef={autoFocusRef}>{children}</FocusTrap>\n      </div>\n    );\n  };\n\n  const isMounted = status !== 'unmounted';\n  if (isMounted) {\n    // Modal vs. modelss upper wrapper\n    if (modality === 'modal') {\n      return <Modal isOpen={isMounted}>{renderDrawer()}</Modal>;\n    } else {\n      return <Layer>{renderDrawer()}</Layer>;\n    }\n  }\n\n  return null;\n};\n"],"names":["zero","duration","children","isOpen","autoFocusRef","placement","modality","onClose","onTransitionEnd","ariaLabel","ariaLabelledBy","ariaDescribedBy","props","status","setStatus","useState","visibility","setVisibility","isOutsideClickDisabled","setIsOutsideClickDisabled","displayModeHorizontal","setDisplayModeHorizontal","rootRef","useRef","launcherRef","isBottomPlacement","animationStates","opening","from","translateY","getTranslateY","to","options","translateX","getTranslateX","closing","direction","useUser","normalizePosition","element","current","Math","round","getBoundingClientRect","width","offsetHeight","nodeRef","useAnimation","isAnimatedOnMount","onAnimationEnd","useCallback","useEffect","activeElement","getActiveElement","document","body","addEventListener","launcherKeyDownCallback","removeEventListener","event","code","preventDefault","stopPropagation","focusWithin","handleKeyDown","launcherEl","reason","focusOn","handleOutsideClick","useOutsideClick","isDisabled","ref","handler","handleResize","viewportWidth","getViewportWidth","clientHints","getClientHints","platform","documentElement","clientWidth","window","innerWidth","resizeObserver","ResizeObserver","observe","unobserve","classes","useComponentTheme","DrawerPopupRedwoodTheme","interpolations","Object","values","colorInterpolations","styleInterpolations","mergeInterpolations","styles","renderDrawer","_jsx","className","style","tabIndex","role","onKeyDown","FocusTrap","isMounted","jsx","Modal","Layer"],"mappings":"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"}